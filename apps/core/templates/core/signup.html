{% extends 'core/base.html' %}

{% block title %} Sign up | {% endblock %}

{% block content %}

<section class="hero is-medium is-light is-bold">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">Signup Today</h1>
      <h2 class="subtitle">Get a free account and start tracking your time</h2>
    </div>
  </div>
</section>

<div class="columns" id="signup-app">
  <div class="column is-6 is-offset-3">
    <form method="post" action="." class="mt-6" v-on:submit="validateForm" novalidate>
      {% csrf_token %}

      {% if form.errors %}
        <div class="notification is-danger">
          {{ form.non_field_errors }}

          {% for field in form %}
            {% if field.errors %} <p>{{ field.label }}: {{ field.errors|striptags }}</p> {% endif %} 
          {% endfor %}
        </div>
      {% endif %}

      <div class="notification is-danger" v-if="errors.length">
        <p v-for="error in errors">
          [[ error ]]
        </p>
      </div>
      <div class="field">
        <label for="id_username">Email</label>
        <div class="control">
          <input type="email" name="username" id="id_username" class="input" v-model="username">
        </div>
      </div>
      <div class="field">
        <label for="id_password">Password</label>
        <div class="control">
          <input type="password" name="password" id="id_password" class="input" v-model="password">
        </div>
      </div>
      <div class="field">
        <label for="id_password_confirm">Confirm Password</label>
        <div class="control">
          <input type="password" name="password_confirm" id="id_password_confirm" class="input" v-model="password_confirm">
        </div>
      </div>
      <ul class="password-help-text">
        <li v-if="password.length < 8">Password too short, must be a mimimum of 8 characters</li>
        <li v-if="!isNaN(password)">Password cannot be all numbers.</li>
      </ul>

      <div class="field">
        <div class="control">
        <button class="button is-success">Sign up</button>
        </div>
      </div>
    </form>

    <hr>
    <h2 class="subtitle">Already have an account?</h2>
    <a href="{% url 'login' %}">Log into your account</a>
  </div>
</div>
{% endblock %}
  
{% block scripts %}
<script>
  const SignupApp = {
    data() {
      return {
        username: '',
        password: '',
        password_confirm: '',
        errors: [],
      }
    },
    delimiters: [ // change delimiters not to use twig style
                  '[[',
                  ']]',
                ],
    methods: {
      validateForm(e) {
        this.errors = [];

        if (!this.validateEmail(this.username)) {
          this.errors.push('Invalid e-mail address');
        }

        if (this.password === '') {
          this.errors.push('Must specify a password');
        }

        if (this.password.length < 8) {
          this.errors.push('Password too short');
        }

        if (this.password !== this.password_confirm) {
          this.errors.push('Passwords do nomatch.');
        }

        if (!isNaN(this.password)) {
          this.errors.push('Password requirements not met.');
        }


        if (this.errors.length) {
          e.preventDefault();

          debugger;
          return false;
        } else {
          console.log('Submitting...');
          return true;
        }
      },
      validateEmail(email) {
        const pattern = /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;
        return pattern.test(email)
        //if (/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/.test(email)) {
        //  return true;
        //} else {
        //  return false;
        //}
      }
    },
  };

  Vue.createApp(SignupApp).mount('#signup-app');
</script>
{% endblock %}
